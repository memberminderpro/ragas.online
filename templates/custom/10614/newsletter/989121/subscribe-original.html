<!--
	This form is customized for ESRAG
	Revision: 09/10/2021
 -->
 <!doctype html>
 <html lang="en">
 <head>
     <title>ESRAG Newsletter</title>
     <meta charset = "UTF-8" />
     <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
     <script  src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.1/jquery.validate.min.js"></script>
     <link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css" integrity="sha384-AYmEC3Yw5cVb3ZcuHtOA93w35dYTsvhLPVnYs9eStHfGJvOvKxVfELGroGkvsg+p" crossorigin="anonymous"/>
     <style>
     .error {color: red}
     input.error { border: 2px solid red;}
     .star {color: red; font-weight:bold;}
     </style>
     <script type="text/javascript">
     $(document).ready(function(){
         //alert("ready");
     });
     </script>
 </head>
 <body data-rsssl=1 data-rsssl=1 data-rsssl=1 data-rsssl=1 data-rsssl=1 data-rsssl=1 data-rsssl=1 data-rsssl=1 data-rsssl=1 data-rsssl=1 data-rsssl=1>
 <!--
     This form is customized for ESRAG
  -->
 
 <div id="Step1">
     <form id="form" name="form" Action="https://www.emembersdb.com/nm/custom.cfm" method="Post">
         <!-- These parameters MUST be changed for each account membership application -->
         <input type="hidden" name="AccountID" 		value="10614" 					id="AccountID" />		<!-- Account -->
         <input type="hidden" name="ClubID" 			value="989121" />										<!-- Newsletter Club -->
         <input type="hidden" name="memberid" 		value="0" />											<!-- Default memberid -->
         <input type="hidden" name="UserID" 			value="0" 						id="UserID" />			<!-- UserID of newsletter member -->
 
         <input type="hidden" name="AddressTypeID" 	value="1" />											<!-- Default Address type -->
         <input type="hidden" name="EmailTypeID" 	value="1"  />											<!-- Default Email type -->
         <input type="hidden" name="MemberTypeID" 	value="504" />											<!-- Default memberide -->
         <input type="hidden" name="UserStatusCode" 	value="P" />											<!-- DefaultUser Status -->
         <input type="hidden" name="AccountEmail" 	value="membership@esrag.org" 	id="AccountEMail" />	<!-- Who gets the application -->
         <input type="hidden" name="FormType" 		value="Newsletter" />												<!--Type of form -->
       <input type="hidden" name="MCY" 			value="504|0|99" 					id="MCY" />	<!-- MemberTypeID, Cost, No Years  -->
 
         <input type="hidden" name="FKClubName" 		value="" />												<!--Rotary Club -->
         <!--- ESRAG wants these fields as part of the Address Record --->
         <input type="hidden" name="Address1" 		value="(tbd)" />										<!--- need to fake out save --->
         <input type="hidden" name="StateCode" 		value="" 						id="StateCode"	/>
         <input type="hidden" name="ProvOrOther" 	value="" 						id="ProvOrOther"/>
         <input type="hidden" name="CountryCode" 	value="" 						id="CountryCode"	/>
 
         <table border="0" cellpadding="3" cellspacing="0">
             <tbody>
                 <tr>
                     <td class="TDData" width="170"><span class="star">*</span>  First Name: </td>
                     <td class="TDData"><input class="entry" id="firstname" maxlength="32" name="firstname" value="" style="height: 25px;" onkeypress="return noEnter(event)" required size="32" type="text" value="" /></td>
                 </tr>
                 <tr>
                     <td class="TDData" width="170"><span class="star">*</span>  Last Name: </td>
                     <td class="TDData"><input class="entry" id="lastname" maxlength="32" name="lastname" value="" style="height: 25px;" onkeypress="return noEnter(event)" required size="32" type="text" value="" /></td>
                 </tr>
                 <tr>
                     <td class="TDData" width="170"><span class="star">*</span>  EMail:  </td>
                     <td class="TDData">
                         <input class="email entry" id="Email" maxlength="64" name="email" value="" style="height: 25px;" onkeypress="return noEnter(event)" required size="32" type="text" value="" />
                         <div id="EMailDiv" style="display: none; color: red"></div>
                     </td>
                 </tr>
                 <tr>
                     <td class="TDData" width="170"><span class="star">*</span>  Country: </td>
                     <td class="TDData">
                         <select id="fkcountry" name="fkcountry" style="width: 300px;" class="TxtIn CountryLookup" required></select>
                     </td>
                 </tr>
                 <tr id="staterow">
                     <td class="TDData" width="170"> State/Province: </td>
                     <td class="TDData">
                         <select id="fkstateprov" name="fkstateprov" style="width: 300px;" class="TxtIn StateProvLookup" required></select>
                     </td>
                 </tr>
                 <tr>
                     <td class="TDData" width="170">Captcha Code: </td>
                     <td class="TDData" align="top">
                         <input type="text" id="captchaCode" name="captchaCode" size="5" style="text-transform: uppercase; position: relative; bottom: 5px;" required>
                         <div id="captcha" style="display: inline; position: relative;"></div><BR>
                         <div id="captchaError" style="display: none;"></div>
                     </td>
                 </tr>
             </tbody>
     </table>
     <input id="Send" type="button" name="Send" value="Subscribe Now" class="btn btn-warning noprint" style="display: block;">
     <div id="Msg"></div>
     <br><br>
 </div>
 
 <div id="Step2" style="display:none;">
 <BR>
 </div>
 </form>
 <BR><BR><BR><BR>
 <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
 <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
 <script>
 var captchaHash = '';
 
 $(document).ready(function() {
     // alert("ready");
 
     DisplayCaptcha()
 
     $("#redoCaptcha").click(function() {
         console.log("redoCaptcha")
         DisplayCaptcha()
     });
 
     $("#Send").click(function() {
         var f = $("#form").serialize();
         if ( $("#form").valid() ) {
             try {
                 console.log (f);
                 console.log ("captchaHash="+captchaHash);
                 console.log ("captchaCode="+$('#captchaCode').val());
                 $.ajax({
                     type: "POST",
                     url: "https://www.emembersdb.com/CFC/Captcha.cfc",
                     data: {
                         method: 'chkCaptcha',
                         captchaHash: captchaHash,
                         captchaCode: $('#captchaCode').val(),
                         timeout: 8000
                     },
                     error: function(){
                         alert("error");
                     },
                     success: function(data) {
                         var rsp = JSON.parse(data);
                         if (rsp.SUCCESS == false) {
                             $('#captchaError').html(rsp.ERROR);
                             $('#captchaError').show();
                             }
                         else {
                             $('#captcha').html('');
                             $('#captchaError').hide();
                             // alert("OK to Submit Form");
               $("#Send").hide();
                             document.form.submit();
               /*
                             $.ajax({
                                 type: 'POST',
                                 // Because ESRAG wants to save the address, this is a full member add
                                 url: 'https://iMembersdb.net:9400/API//Membership/Member?api_key=df9824bc63eb4d4c94ccd04d6dcef898',
                                 //url: 'https://iMembersdb.net:9400/API//Signup/Newsletter?api_key=df9824bc63eb4d4c94ccd04d6dcef898',
                                 data: f,
                                 error: function(jqXHR, textStatus, errorThrown) {
                                     $("#Send").show();
                                     alert("Could not submit newsletter form: "+textStatus+" Error: "+errorThrown);
                                 },
                                 success: function (data) {
                                     var obj = $.parseJSON(JSON.stringify(data));
                                     console.log (obj);
                                     if (!obj.STATUS) {
                                         $("#Step1").show();
                                         $("#Step2").hide();
                                         }
                                     else {
                                         $("#UserID").val( obj.USERID );
                                         $("#Step1").hide();
                                         $("#Step2").show();
                                         SendEMail();
                                     }
                                 }
                             });
               */
                         }
                     }
                 });
             }
             catch(error) {
                 alert("Could not submit form.")
             }
         }
         else {
             alert("Some required fields were not entered")
         }
     });
 
     $( "#Email" ).change(function() {
       console.log( "Handler for email .change() called." );
           $.ajax({
              url: 'https://www.emembersdb.com/Lookup/EMailCheck.cfm',
              //url: 'http://emdb.com/Lookup/EMailCheck.cfm',
             type: "POST",
              dataType: 'json',
             data: {
                 AccountID: $("#AccountID").val(),
                 Email:	   $(this).val(),
                 IsActive:  'N'	// N=Search all Member types  prvent duplicate emails getting in
                 }
         }).done( function( data ) {
             console.log (data)
             if (data == 1) {
                 $("#EMailDiv").show();
                 $("#EMailDiv").html("This email is already in the system.<BR>Please email membership at " + $("#AccountEMail").val() + " to change your membership type.");
                 $("#Send").hide();
                 console.log ("EMail found")
             }
             else {
                 $("#EMailDiv").hide();
                 $("#Send").show();
                 console.log ("EMail NOT found")
             }
         });
     });
 
     $('.CountryLookup').on('select2:select', function (e) {
         var data = e.params.data;
         console.log(data)
         console.log("id="+data.id)					// countrycode
         console.log("country="+data.text)			// countryname
         console.log("cnt="+data.cnt)				// count of states
         $("#CountryCode").val( data.id )			// countrycode
         if ( data.cnt == 0)
             $("#staterow").hide();
         else
             $("#staterow").show();
     });
     $('.CountryLookup').select2({
          placeholder:  'Select Country',
          //tags: 		  true,
          ajax: {
              url: 'https://www.emembersdb.com/Lookup/FKRotaryCountry.cfm',
               //url: 'http://emdb.com/Lookup/FKRotaryCountry.cfm',
             type: "POST",
              dataType: 'json',
              quietMillis: 100,
             data: function (params) {
                 var query = {
                     term: 	params.term
                 }
                 return query;
             }
          },
         results: function (data) {
             results = [];
             $.each(data, function(index, item){
                 results.push({
                     id: 	item.id,
                     text: 	item.text
                 });
             });
             return {
                 results: results
             };
         },
          createTag: function (params) {
             return {
                 id: params.term,
                 text: params.term,
                 newOption: true
             }
         }
     });
 
     $('.StateProvLookup').on('select2:select', function (e) {
         var data = e.params.data;
         console.log(data)
         console.log("id="+data.id)					// statecode
         console.log("country="+data.text)			// StateProv
         $("#StateCode").val( data.statecode )		// statecode
         $("#ProvOrOther").val( data.province )		// Province
     });
     $('.StateProvLookup').select2({
          placeholder: 'Select State or Province',
          tags: 		  true,
          ajax: {
              url: 'https://www.emembersdb.com/Lookup/FKRotaryStateProv.cfm',
              // url: 'http://emdb.com/Lookup/FKRotaryStateProv.cfm',
             type: "POST",
              dataType: 'json',
              quietMillis: 100,
             data: function (params) {
                 var country = $("#fkcountry").val();	// countrycode
                 console.log ("country="+country);
                 if ( country.length == 0 ){
                     alert("select Country first!");
                     return '[]';
                 }
                 var query = {
                     countrycode: country,
                     AccountID: $("#AccountID").val(),
                     term: 	params.term
                 }
                 return query;
             }
          },
         results: function (data) {
             results = [];
             $.each(data, function(index, item){
                 results.push({
                     id: 	item.id,
                     text: 	item.text
                 });
             });
             return {
                 results: results
             };
         },
          createTag: function (params) {
             return {
                 id: params.term,
                 text: params.term,
                 newOption: true
             }
         }
     });
 
 });
 
 function SendEMail() {
     var f = $("#form").serialize();
     $.ajax({
         type: "POST",
         url: "https://www.emembersdb.com/Portal/ESRAG/Newsletter.cfm",
         //url: "http://emdb.com/Portal/ESRAG/Newsletter.cfm",
         data: f,
         error: function(){
             alert("error");
         },
         success: function(data) {
             $('#Step2').html( data );
             console.log ("new newsletter subscriber email sent")
         }
     });
     return false;
 }
 
 function DisplayCaptcha() {
     $.ajax({
         type: "POST",
         url: "https://emembersdb.com/CFC/Captcha.cfc",
         data: {
             method: 'getCaptcha',
             timeout: 16000,
         },
         error: function(){
             alert("error");
         },
         success: function(data) {
             var rsp = JSON.parse(data);
             captchaHash = rsp.CAPTCHAHASH;
             $('#captcha').html('<img src="data:image/png;base64,'+rsp.CAPTCHA + '"> <a href="#" onclick="return DisplayCaptcha();"> <i class="fa fa-redo-alt fa-lg" style="margin-left: 10px; vertical-align:12px; padding: 10px; border: 1px solid grey; background-color: ghostwhite;"></i></span><br/>');
         }
     });
     return false;
 }
 
 function noEnter(e) { // Do not allow Enter Key to cause submission
 var keycode;
 if (window.event)
 keycode = window.event.keyCode;
 else if (e)
 keycode = e.which;
 return !(keycode == 13);
 }
 </script>
 
 </body>
 </html>